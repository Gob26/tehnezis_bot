# tehnezis_bot

Это Телеграм-бот, который помогает собирать и обрабатывать данные с веб-сайтов по заданным правилам из Excel-файла.

## О проекте

Этот бот создан для автоматизации рутинного сбора информации (например, цен на товары) с веб-страниц. Вместо того чтобы вручную посещать множество сайтов, вы можете подготовить Excel-таблицу с описанием того, что нужно найти. Вы отправляете файл боту, и он выполняет всю работу:

1.  **Читает Excel:** Принимает файл с колонками, описывающими, что искать: `title` (название), `url` (адрес веб-страницы) и `xpath` (инструкция, как найти нужный элемент на странице).
2.  **Собирает данные с сайтов:** Бот переходит по указанным URL и, используя `xpath`, находит нужную информацию (например, цену товара) на веб-странице. **Важно:** Если цена уже указана в колонке `price` в Excel, бот использует это значение и не заходит на сайт.
3.  **Обрабатывает и сохраняет:** Полученные данные очищаются, нормализуются и затем сохраняются в базу данных.

Это очень удобно для задач мониторинга цен, сбора каталогов товаров или любой другой ситуации, где требуется извлечь данные из структурированных онлайн-источников.

## Как это работает (Технический обзор)

Бот построен с использованием современного асинхронного фреймворка `aiogram` для взаимодействия с Telegram API. Для эффективной работы с веб-страницами применяются библиотеки `httpx` (для выполнения асинхронных HTTP-запросов) и `lxml` (для парсинга HTML и поиска данных с помощью XPath).

Чтение данных из Excel-файлов осуществляется при помощи мощной библиотеки `pandas`. Управление структурой базы данных (создание таблиц, изменения) происходит с помощью инструмента `alembic` (миграции). Для управления всеми зависимостями проекта используется менеджер `Poetry`.

Примерный цикл работы:

1.  Пользователь отправляет Excel-файл боту в Telegram.
2.  Бот получает файл, временно сохраняет его и начинает обработку каждой строки.
3.  Для каждой записи из Excel:
    * URL нормализуется для корректного запроса.
    * Если цена не указана, выполняется асинхронный запрос к URL.
    * С помощью XPath извлекается нужный текст с веб-страницы.
    * Извлеченный текст (например, цена) очищается от лишних символов и преобразуется в числовой формат.
    * Создается объект данных, готовый к сохранению.
4.  Все собранные и обработанные данные массово сохраняются в базу данных.
5.  Бот отправляет пользователю отчет о результатах обработки файла и добавленных записях.

## Структура проекта

Проект организован следующим образом:

* `alembic/`: Файлы конфигурации и скрипты миграций для базы данных.
* `core/`: Содержит ядро бизнес-логики:
    * `entities/`: Определение основных сущностей (модели данных для БД - `models.py`), схем данных (для валидации и передачи данных - `schemas.py`) и логики работы с хранилищем данных (репозитории - `repositories.py`).
    * `interfaces/`: (Зарезервировано для определения интерфейсов внешних сервисов).
    * `use_cases/`: Реализация конкретных сценариев использования, например, `process_file.py` содержит логику обработки загруженного Excel-файла.
* `infrastructure/`: Содержит реализацию взаимодействия с внешними системами и сервисами:
    * `config.py`: Загрузка и обработка конфигурации (например, из `.env` файла).
    * `database/`: Код для установки соединения с базой данных и работы с сессиями.
    * `telegram_bot/`: Логика, связанная с Телеграм API (обработчики команд, создание клавиатур).
    * `file_data_source/`: (Компоненты для работы с файлами как источником/приемником данных).
    * `web_data_source/`: (Компоненты для получения данных из веб-источников).
* `exel_file/`: Временная директория для хранения файлов, загруженных пользователем.
* `bot.py`: Главный исполняемый файл, инициализирует и запускает Телеграм-бота.
* `docker-compose.yml`: Файл для определения и запуска многоконтейнерных Docker-приложений (используется для развертывания базы данных и/или бота в контейнерах).
* `pyproject.toml` и `poetry.lock`: Файлы менеджера зависимостей Poetry. `pyproject.toml` перечисляет необходимые библиотеки, а `poetry.lock` фиксирует их точные версии.
* `tests/`: Папка для автоматизированных тестов.

## Зависимости

Проект использует Poetry для управления библиотеками. Все необходимые пакеты перечислены в файле `pyproject.toml`. Основные зависимости включают:

* `python`: Язык программирования.
* `aiogram`: Фреймворк для создания Телеграм-ботов.
* `pandas`: Для работы с данными, включая чтение Excel.
* `openpyxl`: Бэкенд для pandas для чтения `.xlsx` файлов.
* `lxml`: Быстрая библиотека для парсинга HTML/XML.
* `httpx`: Асинхронный HTTP-клиент.
* `sqlalchemy`: Мощный ORM для работы с базами данных.
* `asyncpg`: Асинхронный драйвер для PostgreSQL.
* `python-dotenv`: Для загрузки переменных окружения из файла `.env`.
* `alembic`: Инструмент для миграции баз данных.
* `docker`: (Может быть нужен для взаимодействия с Docker из кода, если используется).

## Как запустить проект локально

Чтобы запустить этот бот на вашем компьютере, следуйте инструкциям:

1.  **Убедитесь, что у вас установлено:**
    * Python 3.9 или более новой версии.
    * Менеджер зависимостей Poetry. Инструкцию по установке можно найти на [официальном сайте Poetry](https://python-poetry.org/docs/#installation).
    * Docker и Docker Compose (рекомендуется для простой установки и запуска базы данных).

2.  **Клонируйте репозиторий:**
    Откройте терминал и выполните команду клонирования. Используйте адрес вашего репозитория на GitHub:
    ```bash
    git clone [https://github.com/Gob26/tehnezis_bot.git](https://github.com/Gob26/tehnezis_bot.git)
    ```
    Перейдите в папку склонированного проекта:
    ```bash
    cd tehnezis_bot
    ```

3.  **Установите зависимости проекта:**
    Внутри папки проекта выполните команду Poetry:
    ```bash
    poetry install
    ```
    Poetry прочитает `pyproject.toml` и `poetry.lock` и установит все необходимые библиотеки в виртуальное окружение.

4.  **Настройте переменные окружения:**
    Создайте файл с именем `.env` в корневой директории проекта. В этом файле укажите необходимые настройки, такие как токен вашего Телеграм-бота и URL для подключения к базе данных. Пример:
    ```env
    TELEGRAM_BOT_TOKEN=ВАШ_ТОКЕН_ПОЛУЧЕННЫЙ_У_BOTFATHER
    DATABASE_URL=postgresql+asyncpg://пользователь:пароль@хост:порт/название_бд
    ```
    (URL базы данных может отличаться в зависимости от того, как и где запущена ваша БД).

5.  **Подготовьте базу данных (если используете Docker Compose):**
    Если вы планируете использовать базу данных, запущенную через Docker Compose (определена в `docker-compose.yml`), сначала запустите ее сервис:
    ```bash
    docker-compose up -d db
    ```
    Затем примените миграции базы данных, чтобы создать нужные таблицы:
    ```bash
    poetry run alembic upgrade head
    ```

6.  **Запустите бота:**
    Теперь вы можете запустить основной скрипт бота:
    ```bash
    poetry run python bot.py
    ```
    Или, если у вас настроен сервис бота в `docker-compose.yml`, можете запустить его через Docker Compose:
    ```bash
    docker-compose up --build bot
    ```

## Использование бота

После успешного запуска бота, найдите его в приложении Telegram по имени пользователя. Начните диалог (например, командой `/start`), а затем просто отправьте боту ваш Excel-файл, содержащий информацию в колонках `title`, `url`, `xpath`, и опционально `price`.

---

Как вам такой вариант оформления README? Все ли разделы понятны и хорошо структурированы?
