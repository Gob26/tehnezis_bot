# tehnezis_bot

Привет! Это Телеграм-бот, который помогает собирать и обрабатывать данные с веб-сайтов по заданным правилам из Excel-файла.

## О проекте

Этот бот создан для автоматизации сбора информации (например, цен) с веб-страниц. Вместо того чтобы вручную заходить на множество сайтов, вы просто подготавливаете Excel-таблицу со списком того, что нужно собрать, отправляете ее боту, а он делает всю рутинную работу:

1.  **Читает Excel:** Принимает файл с описанием данных, которые нужно найти (название, адрес страницы - URL, и "путь" к нужному элементу на странице - XPath).
2.  **Собирает данные с сайтов:** Переходит по указанным URL и, используя XPath, находит нужную информацию (например, цену товара). Если цена уже указана в Excel, бот использует ее, не заходя на сайт.
3.  **Сохраняет:** Обработанные данные сохраняются в базу данных для дальнейшего использования или анализа.

Это удобно для мониторинга цен, сбора информации о товарах, или любой другой задачи, где нужно получить данные из структурированных источников в интернете.

## Как это работает

Бот построен на фреймворке `aiogram` для работы с Telegram API. Для взаимодействия с веб-страницами используются библиотеки `httpx` (для запросов) и `lxml` (для анализа HTML и поиска по XPath). Данные из Excel читаются с помощью `pandas`. Информация сохраняется в базу данных, управление структурой которой происходит через `alembic`. Все зависимости управляются с помощью `Poetry`.

Примерный поток работы:

1.  Вы отправляете боту в Telegram Excel-файл (например, `exel_file/111eee.xlsx`).
2.  Бот получает файл и обрабатывает его построчно.
3.  Для каждой строки:
    * Нормализуется URL.
    * Если цена не указана в Excel, выполняется HTTP-запрос к URL.
    * С помощью XPath находится нужный элемент на странице.
    * Извлеченный текст очищается и преобразуется в число (цену).
    * Создается запись для сохранения.
4.  Все собранные данные сохраняются в базу данных.
5.  Бот отправляет вам сообщение с отчетом о проделанной работе.

## Структура проекта

* `alembic/`: Файлы для миграции базы данных (изменения в структуре БД).
* `core/`: Содержит основную бизнес-логику проекта:
    * `entities/`: Описание моделей данных (`models.py`), схем (`schemas.py`) и репозиториев (логика взаимодействия с данными) (`repositories.py`).
    * `interfaces/`: (Планируются интерфейсы для взаимодействия с внешними сервисами).
    * `use_cases/`: Сценарии использования, например, логика обработки файла (`process_file.py`).
* `infrastructure/`: Реализация внешних взаимодействий:
    * `config.py`: Настройки и конфигурация бота (токен Telegram, параметры БД).
    * `database/`: Код для подключения и работы с базой данных.
    * `telegram_bot/`: Обработчики команд и сообщений Telegram, клавиатуры.
    * `file_data_source/`: (Для работы с файлами как источником данных).
    * `web_data_source/`: (Для работы с веб-источниками данных).
* `exel_file/`: Папка для временного хранения загруженных Excel-файлов.
* `bot.py`: Точка входа в программу, запускает Телеграм-бота.
* `docker-compose.yml`: Файл для оркестрации (управления) сервисами с помощью Docker (обычно включает базу данных и самого бота).
* `pyproject.toml` и `poetry.lock`: Файлы менеджера зависимостей Poetry, описывают список библиотек, необходимых проекту
python = "^3.12"
pyTelegramBotAPI = "^4.24.0"
pandas = "^2.2.3"
openpyxl = "^3.1.3"
lxml = "^5.3.0"
aiohttp = "^3.11.16"
sqlalchemy = "^2.0.40"
asyncpg = "^0.30.0"
python-dotenv = "^1.1.0"
alembic = "^1.15.2"
docker = "^7.1.0"
aiogram = "^3.20.0"
httpx = "^0.28.1"

* `tests/`: Папка для тестов.

## Как запустить проект

Чтобы запустить этот проект на своем компьютере, вам потребуется:

* Установленный Python 3.9 или новее.
* Установленный менеджер зависимостей Poetry. Если его нет, установите по инструкции с официального сайта Poetry.
* Установленный Docker и Docker Compose (рекомендуется для простой настройки базы данных).

Порядок действий:

1.  **Склонируйте репозиторий:**
    Откройте терминал и выполните:
    ```bash
    git clone [https://github.com/Gob26/tehnezis_bot.git](https://github.com/Gob26/tehnezis_bot.git)
    cd tehnezis_bot
    ```
    *(Используйте HTTPS URL, если у вас не настроен SSH ключ)*

2.  **Установите зависимости:**
    Перейдите в папку проекта (`cd tehnezis_bot`) и выполните:
    ```bash
    poetry install
    ```
    Poetry прочитает `pyproject.toml` и установит все необходимые библиотеки.

3.  **Настройте переменные окружения:**
    Создайте файл с именем `.env` в корневой папке проекта. В этом файле нужно будет указать токен вашего Телеграм-бота и параметры подключения к базе данных. Пример содержимого `.env` (уточните необходимые переменные, посмотрев `infrastructure/config.py`):
    ```env
    TELEGRAM_BOT_TOKEN=ВАШ_ТОКЕН_БОТА
    DATABASE_URL=postgresql+asyncpg://user:password@db:5432/mydatabase # Пример URL для PostgreSQL в Docker
    ```
    (Получить токен бота можно у @BotFather в Telegram).

4.  **Запустите базу данных (с помощью Docker Compose):**
    Если вы используете базу данных в Docker (как предполагает `docker-compose.yml`), запустите ее:
    ```bash
    docker-compose up -d db
    ```
    Опция `-d` запускает сервис в фоновом режиме.

5.  **Примените миграции базы данных:**
    Это создаст нужные таблицы в базе данных согласно моделям в коде. Выполните в папке проекта:
    ```bash
    poetry run alembic upgrade head
    ```

6.  **Запустите бота:**
    Теперь вы можете запустить самого Телеграм-бота.
    Либо напрямую с помощью Poetry:
    ```bash
    poetry run python bot.py
    ```
    Либо с помощью Docker Compose (если вы добавили сервис бота в `docker-compose.yml`):
    ```bash
    docker-compose up --build bot
    ```

После запуска бот должен стать активным в Telegram.
